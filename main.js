"use strict";var b=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var $=(o,t)=>{for(var e in t)b(o,e,{get:t[e],enumerable:!0})},W=(o,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of _(t))!G.call(o,i)&&i!==e&&b(o,i,{get:()=>t[i],enumerable:!(n=O(t,i))||n.enumerable});return o};var z=o=>W(b({},"__esModule",{value:!0}),o);var J={};$(J,{default:()=>A});module.exports=z(J);var C=require("obsidian");var T=require("obsidian"),v=class{constructor(t,e){this.LEFT_X=0;this.RIGHT_X=420;this.SPACING=180;this.app=t,this.canvasPath=e}async ensureCanvas(){let t=this.app.vault.getAbstractFileByPath(this.canvasPath);return t instanceof T.TFile?t:await this.app.vault.create(this.canvasPath,JSON.stringify({nodes:[],edges:[]},null,2))}async addEntry(t){let e=await this.ensureCanvas();await this.app.vault.process(e,n=>{let i;try{i=JSON.parse(n)}catch(p){i={nodes:[],edges:[]}}Array.isArray(i.nodes)||(i.nodes=[]);let a=0,s=0;for(let p of i.nodes){if(p.type!=="text")continue;(p.text||"").includes("#familiar")?s=Math.max(s,p.y||0):a=Math.max(a,p.y||0)}let r=t.mastered,c=r?this.RIGHT_X:this.LEFT_X,l=r?s+this.SPACING:a+this.SPACING,d=[];return d.push(t.normalized),t.definition&&(d.push(""),d.push(t.definition)),d.push(""),d.push(`#${t.type}`),d.push(t.mastered?"#familiar":"#unfamiliar"),i.nodes.push({id:t.id,type:"text",x:c,y:l,width:320,height:160,text:d.join(`
`)}),JSON.stringify(i,null,2)})}async reflowLayout(){let t=await this.ensureCanvas();await this.app.vault.process(t,e=>{let n;try{n=JSON.parse(e)}catch(s){return e}if(!Array.isArray(n.nodes))return e;let i=0,a=0;for(let s of n.nodes){if(s.type!=="text")continue;(s.text||"").includes("#familiar")?(s.x=this.RIGHT_X,s.y=a,a+=this.SPACING):(s.x=this.LEFT_X,s.y=i,i+=this.SPACING)}return JSON.stringify(n,null,2)})}};var k=require("obsidian"),w=class{constructor(t,e){this.entries=[];this.index=new Map;this.version=0;this.app=t,this.canvasPath=e}async load(){this.entries=[],this.index.clear();let t=this.app.vault.getAbstractFileByPath(this.canvasPath);if(!(t instanceof k.TFile))return;let e;try{e=JSON.parse(await this.app.vault.read(t))}catch(n){return}if(Array.isArray(e.nodes)){for(let n of e.nodes){if(n.type!=="text"||typeof n.text!="string")continue;let i=this.parseNode(n.id,n.text);i&&i.text.trim()&&(this.index.has(i.normalized)||(this.entries.push(i),this.index.set(i.normalized,i)))}this.version++}}async reload(){await this.load()}getAllEntries(){return[...this.entries]}getUnfamiliar(){return this.entries.filter(t=>!t.mastered)}exists(t){return this.index.has(t.toLowerCase())}getVersion(){return this.version}parseNode(t,e){let i=e.split(`
`).map(m=>m.trim());for(;i.length&&!i[0];)i.shift();for(;i.length&&!i[i.length-1];)i.pop();if(i.length===0)return null;let a=i[0];if(!a)return null;let s=[],r=i.length-1;for(;r>0&&i[r].startsWith("#");)s.unshift(i[r]),r--;let c=i.slice(1,r+1),l=s.includes("#phrase")?"phrase":(s.includes("#word"),"word"),d=s.includes("#familiar"),p=c.length>0?c.join(`
`).trim():void 0;return{id:t,text:a,normalized:a.toLowerCase(),type:l,mastered:d,definition:p}}};var V=require("@codemirror/state"),u=require("@codemirror/view");function R(o){return[V.StateField.define({create(e){return I(e,o)},update(e,n){let i=o.getVersion();if(n.docChanged||i!==e._v){let a=I(n.state,o);return a._v=i,a}return e},provide:e=>u.EditorView.decorations.from(e)})]}function I(o,t){let e=o.doc,n=e.toString().toLowerCase(),i=t.getUnfamiliar(),a=[];for(let r of i){let c=r.normalized;if(!c)continue;let l=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=r.type==="word"?new RegExp(`\\b${l}\\b`,"g"):new RegExp(l,"g"),p=r.type==="phrase"?"mark-and-read-phrase":"mark-and-read-word",m;for(;m=d.exec(n);){let y=m.index,F=y+m[0].length,P=e.lineAt(y).text;P.includes("```")||P.includes("`")||a.push(u.Decoration.mark({class:p}).range(y,F))}}let s=u.Decoration.set(a,!0);return s._v=t.getVersion(),s}var g=require("obsidian");function N(o){return o.trim().toLowerCase().replace(/\s+/g," ")}function L(o,t,e,n){return{id:"add-to-reading-canvas",name:"Add to Reading Canvas",callback:async()=>{let i=o.workspace.getActiveViewOfType(g.MarkdownView);if(!i){new g.Notice("No active Markdown view");return}let a=i.editor.getSelection().trim();if(!a){new g.Notice("No text selected");return}let s=N(a);if(e.exists(s)){new g.Notice(`Already in Reading Canvas: ${a}`);return}let r=a.includes(" ")?"phrase":"word",c,l=await n.generateDefinition(a);l&&l.length>0&&(c=l);let d={id:crypto.randomUUID(),type:r,text:a,normalized:s,definition:c,mastered:!1};await t.addEntry(d),await e.reload(),new g.Notice(c?`Added ${r}: ${a}`:`Added ${r}: ${a} (no definition)`)}}}var D=require("obsidian"),f="mark-and-read-sidebar",x=class extends D.ItemView{constructor(t,e){super(t),this.cache=e}getViewType(){return f}getDisplayText(){return"Reading Cards"}async onOpen(){this.render()}async onClose(){}refresh(){this.render()}render(){let t=this.containerEl;t.empty();let e=this.cache.getUnfamiliar();if(e.length===0){t.createEl("div",{text:"No unfamiliar cards."});return}for(let n of e){let i=t.createDiv({cls:"mr-card"});i.createEl("div",{text:n.text,cls:"mr-card-title"}),n.definition&&i.createEl("div",{text:n.definition,cls:"mr-card-definition"})}}};var M={canvasPath:"Reading.canvas",ai:{enabled:!0,apiKey:"",endpoint:"https://open.bigmodel.cn/api/paas/v4/chat/completions",model:"glm-4.7-flash"}};var h=require("obsidian"),S=class extends h.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Mark & Read \u2014 Settings"}),new h.Setting(t).setName("Canvas file path").setDesc("Where vocab cards are stored (e.g. Reading.canvas)").addText(e=>e.setValue(this.plugin.settings.canvasPath).onChange(async n=>{this.plugin.settings.canvasPath=n.trim(),await this.plugin.saveSettings()})),t.createEl("h2",{text:"AI Settings"}),new h.Setting(t).setName("Enable AI definition").setDesc("Automatically generate English definitions when adding entries").addToggle(e=>e.setValue(this.plugin.settings.ai.enabled).onChange(async n=>{this.plugin.settings.ai.enabled=n,await this.plugin.saveSettings()})),new h.Setting(t).setName("API Key").setDesc("Your AI service API key").addText(e=>e.setPlaceholder("sk-...").setValue(this.plugin.settings.ai.apiKey).onChange(async n=>{this.plugin.settings.ai.apiKey=n,await this.plugin.saveSettings()})),new h.Setting(t).setName("API Endpoint").setDesc("OpenAI-compatible chat/completions endpoint").addText(e=>e.setValue(this.plugin.settings.ai.endpoint).onChange(async n=>{this.plugin.settings.ai.endpoint=n,await this.plugin.saveSettings()})),new h.Setting(t).setName("Model").setDesc("Model name (e.g. glm-4.7-flash)").addText(e=>e.setValue(this.plugin.settings.ai.model).onChange(async n=>{this.plugin.settings.ai.model=n,await this.plugin.saveSettings()}))}};var E=class{constructor(t){this.settings=t}updateSettings(t){this.settings=t}async generateDefinition(t){var e,n,i,a,s;if(!this.settings.enabled||!this.settings.apiKey)return null;try{let r=await fetch(this.settings.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},body:JSON.stringify({model:this.settings.model,messages:[{role:"user",content:`Give a concise English definition of the word or phrase "${t}". One sentence only.`}]})});if(!r.ok)return null;let c=await r.json();return(s=(a=(i=(n=(e=c==null?void 0:c.choices)==null?void 0:e[0])==null?void 0:n.message)==null?void 0:i.content)==null?void 0:a.trim())!=null?s:null}catch(r){return null}}};var A=class extends C.Plugin{async onload(){await this.loadSettings();let t=this.settings.canvasPath;this.canvasStore=new v(this.app,t),this.cache=new w(this.app,t),this.aiService=new E(this.settings.ai),await this.cache.load();let e=L(this.app,this.canvasStore,this.cache,this.aiService);this.addCommand(e),this.addCommand({id:"reflow-reading-canvas",name:"Reflow Reading Canvas Layout",callback:async()=>{await this.canvasStore.reflowLayout(),await this.cache.reload(),this.refreshSidebar()}}),this.registerEvent(this.app.workspace.on("editor-menu",(n,i)=>{var s,r,c;(c=(r=(s=i==null?void 0:i.getSelection)==null?void 0:s.call(i))==null?void 0:r.trim)!=null&&c.call(r)&&n.addItem(l=>{l.setTitle("Add to Reading Canvas").setIcon("plus").onClick(async()=>{e.callback&&await e.callback()})})})),this.registerView(f,n=>new x(n,this.cache)),this.addSettingTab(new S(this.app,this)),this.app.workspace.onLayoutReady(()=>{let n=R(this.cache);this.registerEditorExtension(n),this.activateSidebar()}),this.registerEvent(this.app.vault.on("modify",async n=>{n instanceof C.TFile&&n.path===t&&(await this.cache.reload(),this.refreshSidebar())})),console.log("[MarkAndRead] loaded")}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.aiService.updateSettings(this.settings.ai)}async activateSidebar(){if(this.app.workspace.getLeavesOfType(f).length>0)return;let e=this.app.workspace.getRightLeaf(!1);e&&await e.setViewState({type:f,active:!0})}refreshSidebar(){let t=this.app.workspace.getLeavesOfType(f);for(let e of t)e.view.refresh()}};
